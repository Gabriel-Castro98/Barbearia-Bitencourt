<!DOCTYPE html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel Admin - Barbearia Bitencourt</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
body { font-family: 'Poppins', sans-serif; }
@keyframes fadeIn {
from { opacity: 0; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}
.animate-fadeIn { animation: fadeIn 0.3s ease forwards; }
.filter-active { background:#fbbf24 !important; color:#000 !important; }
.date-active { background:#fbbf24 !important; color:#000 !important; }
.sort-active { background:#4f46e5 !important; }
</style>
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Tema DARK do Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="style.css">
</head>
<body class="bg-zinc-950 text-zinc-50">
<div class="min-h-screen flex flex-col">


<header class="bg-zinc-900 border-b border-zinc-800 px-6 py-4 relative">
<div class="flex items-center justify-between">
<h1 class="text-2xl font-bold">Painel <span class="text-amber-500">Administrativo</span></h1>


<nav class="hidden md:flex items-center gap-6">
<a href="#agendamentos" class="text-zinc-300 hover:text-amber-500 transition">Agendamentos</a>
<a href="#estatisticas" class="text-zinc-300 hover:text-amber-500 transition">Estat√≠sticas</a>
<a href="index.html" class="text-zinc-300 hover:text-amber-500 transition">√Årea do Cliente</a>
<button id="logout-btn" class="text-red-400 hover:text-red-300 transition-colors">Sair</button>
</nav>

<button id="menu-btn" class="md:hidden flex flex-col justify-between w-6 h-5">
<span class="w-full h-0.5 bg-zinc-300 rounded"></span>
<span class="w-full h-0.5 bg-zinc-300 rounded"></span>
<span class="w-full h-0.5 bg-zinc-300 rounded"></span>
</button>
</div>


<nav id="mobile-menu" class="hidden flex-col bg-zinc-900 border-t border-zinc-800 mt-4 p-4 space-y-3 md:hidden rounded-xl">
<a href="#agendamentos" class="block text-zinc-300 hover:text-amber-500 transition">Agendamentos</a>
<a href="#estatisticas" class="block text-zinc-300 hover:text-amber-500 transition">Estat√≠sticas</a>
<a href="index.html" class="block text-zinc-300 hover:text-amber-500 transition">√Årea do Cliente</a>
<button id="logout-btn-mobile" class="text-red-400 hover:text-red-300 transition-colors">Sair</button>
</nav>
</header>


<main class="flex-1 p-6 space-y-6">
<div id="estatisticas" class="grid md:grid-cols-4 gap-6">
<div class="bg-zinc-900 rounded-xl p-6 border border-zinc-800"><h3 class="text-zinc-400 text-sm mb-2">Hoje</h3><p id="stat-today" class="text-3xl font-bold">0</p></div>
<div class="bg-zinc-900 rounded-xl p-6 border border-zinc-800"><h3 class="text-zinc-400 text-sm mb-2">Confirmados</h3><p id="stat-confirmed" class="text-3xl font-bold">0</p></div>
<div class="bg-zinc-900 rounded-xl p-6 border border-zinc-800"><h3 class="text-zinc-400 text-sm mb-2">Total</h3><p id="stat-total" class="text-3xl font-bold">0</p></div>
</div>


<div class="bg-zinc-900 rounded-xl p-6 border border-zinc-800 space-y-4">


<div class="flex flex-wrap gap-3">
<button onclick="setDateFilter('all', event)" class="date-btn bg-zinc-800 px-4 py-2 rounded transition">Todos</button>
<button onclick="setDateFilter('today', event)" class="date-btn bg-zinc-800 px-4 py-2 rounded">Hoje</button>
<button onclick="setDateFilter('tomorrow', event)" class="date-btn bg-zinc-800 px-4 py-2 rounded">Amanh√£</button>
<button onclick="setDateFilter('week', event)" class="date-btn bg-zinc-800 px-4 py-2 rounded">Semana</button>
<button onclick="setDateFilter('month', event)" class="date-btn bg-zinc-800 px-4 py-2 rounded">M√™s</button>


<input type="text" id="start-range" class="bg-zinc-800 px-3 py-2 rounded" placeholder="In√≠cio">
<input type="text" id="end-range" class="bg-zinc-800 px-3 py-2 rounded" placeholder="Fim">
<button onclick="applyCustomRange()" class="bg-amber-500 text-black px-4 py-2 rounded">Filtrar</button>
</div>


<div class="flex flex-wrap gap-3 items-center mt-2">
<button onclick="filterBookings('all', event)" class="filter-btn filter-active px-4 py-2 rounded">Todos</button>
<button onclick="filterBookings('confirmado', event)" class="filter-btn bg-zinc-800 px-4 py-2 rounded">Confirmados</button>
<button onclick="filterBookings('concluido', event)" class="filter-btn bg-zinc-800 px-4 py-2 rounded">Conclu√≠dos</button>


<button onclick="setSort('newest', event)" class="sort-btn bg-zinc-800 px-4 py-2 rounded">‚¨ÜÔ∏è Mais novos</button>
<button onclick="setSort('oldest', event)" class="sort-btn bg-zinc-800 px-4 py-2 rounded">‚¨áÔ∏è Mais antigos</button>


<input type="text" id="search-input" placeholder="Buscar por nome, data ou servi√ßo..." class="flex-1 min-w-[250px] bg-zinc-800 border border-zinc-700 rounded px-4 py-2">
</div>
</div>

<!-- NOVAS M√âTRICAS -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">

  <div class="stat-card">
    <p class="text-zinc-400 text-sm">Faturamento</p>
    <p id="stat-revenue" class="text-2xl font-bold mt-1">R$ 0</p>
  </div>

  <div class="stat-card">
    <p class="text-zinc-400 text-sm">Ticket M√©dio</p>
    <p id="stat-ticket" class="text-2xl font-bold mt-1">R$ 0</p>
  </div>

  <div class="stat-card">
    <p class="text-zinc-400 text-sm">Clientes √önicos</p>
    <p id="stat-clients" class="text-2xl font-bold mt-1">0</p>
  </div>

  <div class="stat-card">
    <p class="text-zinc-400 text-sm">Servi√ßo mais agendado</p>
    <p id="stat-top-service" class="text-xl font-semibold mt-1">‚Äî</p>
  </div>

  <div class="stat-card">
    <p class="text-zinc-400 text-sm">Hor√°rio mais movimentado</p>
    <p id="stat-top-hour" class="text-xl font-semibold mt-1">‚Äî</p>
  </div>

</div>

<style>
.stat-card {
  @apply bg-zinc-800 border border-zinc-700 rounded-xl p-4;
}
</style>

<section id="agendamentos" class="bg-zinc-900 rounded-xl border border-zinc-800 overflow-hidden">
<div class="p-6 border-b border-zinc-800"><h2 class="text-xl font-bold">Agendamentos em Tempo Real</h2></div>
<div class="overflow-x-auto">
<table class="w-full">
<thead class="bg-zinc-800/50">
<tr>
<th class="px-6 py-4 text-left text-sm">Cliente</th>
<th class="px-6 py-4 text-left text-sm">Servi√ßo</th>
<th class="px-6 py-4 text-left text-sm">Barbeiro</th>
<th class="px-6 py-4 text-left text-sm">Data/Hora</th>
<th class="px-6 py-4 text-left text-sm">Telefone</th>
<th class="px-6 py-4 text-left text-sm">Status</th>
<th class="px-6 py-4 text-left text-sm">A√ß√µes</th>
</tr>
</thead>
<tbody id="bookings-table" class="divide-y divide-zinc-800">
<tr><td colspan="7" class="px-6 py-8 text-center text-zinc-500">Carregando agendamentos...</td></tr>
</tbody>
</table>
</div>
</section>
</main>


<footer class="bg-zinc-900 py-12 text-center text-zinc-400 mt-20">
<p>&copy; 2025 Barbearia Bitencourt. Todos os direitos reservados.</p>
<p>Desenvolvido por Gabriel Castro</p>
</footer>

  <!-- SCRIPT -->
  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { collection, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    let allBookings = [];
    let currentFilter = "all";

    // =========================
    // üìÖ FILTRO POR DATA (GLOBAIS)
    // =========================
    let dateFilter = "all";
    let customStart = null;
    let customEnd = null;
    let sortOrder = "newest";

    // util: converte possivelmente Timestamp do Firestore para Date
    function toDate(value) {
      if (!value) return null;
      // Firestore Timestamp has .toDate()
      if (typeof value === "object" && typeof value.toDate === "function") {
        return value.toDate();
      }
      // if it's already a Date
      if (value instanceof Date) return value;
      // fallback - try parse
      const parsed = new Date(value);
      return isNaN(parsed) ? null : parsed;
    }

    function applyDateFilter(bookings) {
      const now = new Date();
      const todayStr = now.toISOString().split("T")[0];

      return bookings.filter((b) => {
        const d = toDate(b.data);
        if (!d) return false;

        const dISO = d.toISOString().split("T")[0];

        switch (dateFilter) {
          case "today":
            return dISO === todayStr;

          case "tomorrow":
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            return dISO === tomorrow.toISOString().split("T")[0];

          case "week":
            const weekFromNow = new Date(now);
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            return d >= now && d <= weekFromNow;

          case "month":
            return (
              d.getMonth() === now.getMonth() &&
              d.getFullYear() === now.getFullYear()
            );

          case "range":
            if (!customStart || !customEnd) return true;
            // normalize times so inclusive of end day
            const start = new Date(customStart);
            start.setHours(0,0,0,0);
            const end = new Date(customEnd);
            end.setHours(23,59,59,999);
            return d >= start && d <= end;

          default:
            return true;
        }
      });
    }

   // üîí Prote√ß√£o silenciosa baseada em "role"
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    try {
      const userDocRef = doc(db, "usuarios", user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (!userDocSnap.exists() || userDocSnap.data().role !== "admin") {
        console.log("üö´ Acesso negado: usu√°rio n√£o √© admin.");
        window.location.href = "index.html";
        return;
      }

      console.log("‚úÖ Acesso concedido: usu√°rio √© admin.");
      loadBookings(); // S√≥ carrega dados se for admin

    } catch (err) {
      console.error("Erro ao verificar o role do usu√°rio:", err);
      window.location.href = "index.html";
    }
  });

    // üìä Carregar agendamentos
    function loadBookings() {
      const q = query(collection(db, "agendamentos"));
      onSnapshot(q, (snapshot) => {
        allBookings = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        updateStats();
        renderBookings();
      });
    }
    const servicos = [
  { nome: "Corte", preco: 30 },
  { nome: "Corte e Barba", preco: 60 },
  { nome: "Barba Completa", preco: 40 },
  { nome: "Corte + Alisamento", preco: 60 },
  { nome: "Corte + Barba + Alisamento", preco: 80 },
  { nome: "Corte + Barba + Pigmentacao", preco: 70 },
  { nome: "Sobrancelha na Navalha", preco: 5 },
  { nome: "Bigode na Navalha", preco: 5 },
  { nome: "Risquinho Simples", preco: 5 },
  { nome: "Bigode e Cavanhaque", preco: 10 },
];

    function updateStats() {
  const todayStr = new Date().toISOString().split("T")[0];

  // --- AGENDAMENTOS DE HOJE ---
  const createdToday = allBookings.filter((b) => {
    if (!b.criadoEm || !b.criadoEm.toDate) return false;
    const d = b.criadoEm.toDate().toISOString().split("T")[0];
    return d === todayStr;
  });

  document.getElementById("stat-today").textContent = createdToday.length;
  document.getElementById("stat-confirmed").textContent =
    allBookings.filter((b) => b.status === "confirmado").length;
  document.getElementById("stat-total").textContent = allBookings.length;

  // --- APLICAR OS MESMOS FILTROS DO RENDER ---
  let filtered = applyDateFilter(allBookings).filter(
    (b) => b.status && b.status.trim() !== ""
  );

  if (currentFilter !== "all") {
    filtered = filtered.filter((b) => b.status === currentFilter);
  }

  // --- FATURAMENTO TOTAL ---
  let totalRevenue = 0;

  filtered.forEach((b) => {
    if (!b.servico) return;

    // Multiple services (array)
    if (Array.isArray(b.servico)) {
      b.servico.forEach((s) => {
        const serv = servicos.find((x) => x.nome === s);
        if (serv) totalRevenue += serv.preco;
      });
    } else {
      // Single service (string)
      const serv = servicos.find((x) => x.nome === b.servico);
      if (serv) totalRevenue += serv.preco;
    }
  });

  document.getElementById("stat-revenue").textContent =
    `R$ ${totalRevenue.toFixed(2)}`;

  // --- TICKET M√âDIO ---
  const ticket = filtered.length ? totalRevenue / filtered.length : 0;
  document.getElementById("stat-ticket").textContent =
    `R$ ${ticket.toFixed(2)}`;

  // --- CLIENTES √öNICOS ---
  const unique = new Set(filtered.map((b) => b.email));
  document.getElementById("stat-clients").textContent = unique.size;

  // --- SERVI√áO MAIS AGENDADO ---
  const countServices = {};

  filtered.forEach((b) => {
    if (Array.isArray(b.servico)) {
      b.servico.forEach((s) => {
        countServices[s] = (countServices[s] || 0) + 1;
      });
    } else {
      countServices[b.servico] = (countServices[b.servico] || 0) + 1;
    }
  });

  const topService =
    Object.entries(countServices).sort((a, b) => b[1] - a[1])[0]?.[0] || "‚Äî";

  document.getElementById("stat-top-service").textContent = topService;

  // --- HOR√ÅRIO MAIS MOVIMENTADO ---
  const countHours = {};

  filtered.forEach((b) => {
    if (!b.horario) return;
    countHours[b.horario] = (countHours[b.horario] || 0) + 1;
  });

  const topHour =
    Object.entries(countHours).sort((a, b) => b[1] - a[1])[0]?.[0] || "‚Äî";

  document.getElementById("stat-top-hour").textContent = topHour;
}



    function renderBookings() {
      const tbody = document.getElementById("bookings-table");
      const searchTerm = (document.getElementById("search-input").value || "").toLowerCase();
      let filtered = allBookings.slice();

      // Aplica filtro por data (usa toDate internamente)
      filtered = applyDateFilter(filtered);

      // Remove resultados sem status (status = "" ou undefined)
      filtered = filtered.filter((b) => b.status && String(b.status).trim() !== "");

      // Aplica filtro de status (todos / confirmado / concluido)
      if (currentFilter !== "all") filtered = filtered.filter((b) => b.status === currentFilter);

      // Busca inteligente
      if (searchTerm) {
        filtered = filtered.filter((b) => {
          const search = searchTerm;

          // Nome do cliente
          const nome = (b.nome || "").toString().toLowerCase();

          // Servi√ßo (string ou array)
          const servico = Array.isArray(b.servico)
            ? b.servico.join(", ").toLowerCase()
            : String(b.servico || "").toLowerCase();

          // Barbeiro
          const barbeiro = (b.barbeiro || "").toString().toLowerCase();

          // Hor√°rio (13:30)
          const hora = (b.horario || b.hora || "").toString().toLowerCase();

          // Datas poss√≠veis
          let dataBR = "";
          let dataISO = "";
          let diaMes = "";
          let mesAno = "";
          let dia = "";

          const d = toDate(b.data);
          if (d) {
            dataBR = d.toLocaleDateString("pt-BR");      // 14/11/2025
            dataISO = d.toISOString().split("T")[0];     // 2025-11-14
            const parts = dataBR.split("/");
            if (parts.length === 3) {
              const [dd, mm, yyyy] = parts;
              diaMes = `${dd}/${mm}`;                      // 14/11
              mesAno = `${mm}/${yyyy}`;                    // 11/2025
              dia = dd;                                    // 14
            }
          }

          return (
            nome.includes(search) ||
            servico.includes(search) ||
            barbeiro.includes(search) ||
            hora.includes(search) ||
            dataBR.includes(search) ||
            dataISO.includes(search) ||
            diaMes.includes(search) ||
            mesAno.includes(search) ||
            dia.includes(search)
          );
        });
      }
      // üìå Ordena√ß√£o por data
        filtered.sort((a, b) => {
          const da = toDate(a.data);
          const db = toDate(b.data);

          if (!da || !db) return 0;

          return sortOrder === "newest"
            ? db - da   // mais novos primeiro
            : da - db;  // mais antigos primeiro
        });


      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-zinc-500">Nenhum agendamento encontrado.</td></tr>`;
        return;
      }

      const statusColors = {
        confirmado: "bg-green-500/10 text-green-500 border-green-500",
        concluido: "bg-blue-500/10 text-blue-500 border-blue-500",
        cancelado: "bg-red-500/10 text-red-500 border-red-500",
      };

      tbody.innerHTML = filtered
        .map((b) => {
          const dataDisplay = (() => {
            const d = toDate(b.data);
            return d ? d.toLocaleDateString("pt-BR") : "-";
          })();

          const horarioDisplay = b.horario || b.hora || "‚Äî";
          const badgeClass = statusColors[b.status] || "bg-zinc-700 text-zinc-300 border-zinc-700";

          return `
            <tr class="hover:bg-zinc-800/50 transition">
              <td class="px-6 py-4"><div class="font-medium">${b.nome || "-"}</div><div class="text-sm text-zinc-500">${b.email || ""}</div></td>
              <td class="px-6 py-4">${Array.isArray(b.servico) ? b.servico.join(", ") : (b.servico || "-")}</td>
              <td class="px-6 py-4">${b.barbeiro || "-"}</td>
              <td class="px-6 py-4"><div>${dataDisplay}</div><div class="text-sm text-zinc-500">${horarioDisplay}</div></td>
              <td class="px-6 py-4">${b.telefone || "-"}</td>
              <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs font-medium border ${badgeClass}">${(b.status || "").charAt(0).toUpperCase() + (b.status || "").slice(1)}</span></td>
              <td class="px-6 py-4">
                <div class="flex gap-2">
                  ${b.status === "confirmado" ? `<button onclick="updateStatus('${b.id}','concluido')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">Concluir</button>` : ""}
                  <button onclick="deleteBooking('${b.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">Excluir</button>
                </div>
              </td>
            </tr>
          `;
        })
        .join("");
    }

    window.updateStatus = async function (id, status) {
      await updateDoc(doc(db, "agendamentos", id), { status });
    };

    window.deleteBooking = async function (id) {
      if (!confirm("Tem certeza que deseja excluir este agendamento?")) return;
      await deleteDoc(doc(db, "agendamentos", id));
    };

    window.filterBookings = function (filter, event) {
      currentFilter = filter;

      // Limpa campo de busca sempre que mudar filtro
      document.getElementById("search-input").value = "";

      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.classList.remove("bg-amber-500", "text-zinc-950");
        btn.classList.add("bg-zinc-800", "text-zinc-300");
      });

      if (event && event.target) {
        event.target.classList.remove("bg-zinc-800", "text-zinc-300");
        event.target.classList.add("bg-amber-500", "text-zinc-950");
      }

      renderBookings();
    };

    document.getElementById("search-input").addEventListener("input", renderBookings);

    // =========================
    // üîΩ ORDENA√á√ÉO (MAIS NOVOS / ANTIGOS)
    // =========================
    window.setSort = function(type, event) {
      sortOrder = type;

      // Estilo visual do bot√£o ativo
      document.querySelectorAll(".sort-btn").forEach(btn => {
        btn.classList.remove("sort-active");
      });

      if (event && event.target) {
        event.target.classList.add("sort-active");
      }

      renderBookings();
    };

    // =========================
    // üìÖ BOT√ïES DO FILTRO DE DATA
    // =========================
    window.setDateFilter = function (filter, event) {
      dateFilter = filter;

      document.querySelectorAll(".date-btn").forEach((btn) => {
        btn.classList.remove("bg-amber-500", "text-black");
        btn.classList.add("bg-zinc-800");
      });

      if (event && event.target) {
        event.target.classList.remove("bg-zinc-800");
        event.target.classList.add("bg-amber-500", "text-black");
      }

      renderBookings();
    };

    window.applyCustomRange = function () {
      const start = document.getElementById("start-range").value;
      const end = document.getElementById("end-range").value;

      if (!start || !end) {
        alert("Selecione as duas datas.");
        return;
      }

      customStart = new Date(start + "T00:00:00");
      customEnd   = new Date(end   + "T23:59:59");

      dateFilter = "range";
      renderBookings();
    };

    // üçî Menu hamb√∫rguer com anima√ß√£o
    const menuBtn = document.getElementById("menu-btn");
    const mobileMenu = document.getElementById("mobile-menu");
    const logoutBtnMobile = document.getElementById("logout-btn-mobile");
    const logoutBtn = document.getElementById("logout-btn"); // üëà bot√£o desktop

    menuBtn.addEventListener("click", () => {
      mobileMenu.classList.toggle("hidden");
      if (!mobileMenu.classList.contains("hidden")) {
        mobileMenu.classList.add("animate-fadeIn");
      }
    });

    // üì± Logout (mobile)
    if (logoutBtnMobile) {
      logoutBtnMobile.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "login.html";
      });
    }

    // üíª Logout (desktop)
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "login.html";
      });
    }
    // ============================
// üìÖ Flatpickr nos filtros de data
// ============================
flatpickr("#start-range", {
  dateFormat: "Y-m-d",
  locale: "pt",
  monthSelectorType: "dropdown",
  disableMobile: true,
  defaultDate: null,
  onReady: function(selectedDates, dateStr, instance) {
    instance.clear(); // deixa o input vazio
  }
});

flatpickr("#end-range", {
  dateFormat: "Y-m-d",
  locale: "pt",
  monthSelectorType: "dropdown",
  disableMobile: true,
  defaultDate: null,
  onReady: function(selectedDates, dateStr, instance) {
    instance.clear(); // deixa o input vazio
  }
});
  </script>
</body>
</html>

